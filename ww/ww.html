<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>재치와 눈치</title>
    <style>
        /* ... 기존 스타일 유지 ... */
    </style>
</head>
<body>
    <div class="container" id="imageContainer">
        <div class="flipper">
            <div class="front">
                <img src="problem.png" alt="문제">
                <table>
                    <tr>
                        <td id="tdp1"></td>
                    </tr>
                    <tr>
                        <td id="tdp2"></td>
                    </tr>
                </table>
            </div>
            <div class="back">
                <img src="answer.png" alt="정답">
                <table>
                    <tr>
                        <td id="tda1" style="width: 30%;"></td>
                        <td id="tdr1" style="width: 70%;"></td>
                    </tr>
                    <tr>
                        <td id="tda2" style="width: 30%;"></td>
                        <td id="tdr2" style="width: 70%;"></td>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <script>
        const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRBlTDBERR1Ti5fnr68uMBhEc3wVtq_v-3zH61BkLn68es1E6iVcrJ7ZREdcQfalto9JhxAZNeaFLep/pub?output=csv';

        let problems = [];
        let used = [];
        let problemShow = true;

        // 데이터 로딩 상태 표시
        document.getElementById("tdp1").innerHTML = "데이터 로딩 중...";
        document.getElementById("tdp2").innerHTML = "잠시만 기다려주세요";

        async function fetchSheetData() {
            try {
                const response = await fetch(sheetUrl);
                if (!response.ok) throw new Error('Network response was not ok');
                
                const csvText = await response.text();
                const rows = csvText.trim().split('\n');
                rows.shift(); // 헤더 제거

                return rows.map(row => {
                    const [question, answer, reference] = row.split(',');
                    return [question, answer, reference];
                });
            } catch (error) {
                console.error('데이터 가져오기 오류:', error);
                return [];
            }
        }

        async function initApp() {
            problems = await fetchSheetData();
            used = new Array(problems.length).fill(false);
            
            if (problems.length === 0) {
                document.getElementById("tdp1").innerHTML = "데이터를 불러오지 못했습니다";
                document.getElementById("tdp2").innerHTML = "스프레드시트 URL을 확인해주세요";
                return;
            }
            
            await funcProblemSetting();
        }

        async function funcProblemSetting() {
            // 사용 가능한 문제가 없는 경우 리셋
            if (used.every(u => u) && problems.length > 0) {
                used.fill(false);
            }

            const getRandomUnusedIndex = () => {
                const unusedIndices = used
                    .map((isUsed, index) => isUsed ? null : index)
                    .filter(index => index !== null);
                
                if (unusedIndices.length === 0) return null;
                return unusedIndices[Math.floor(Math.random() * unusedIndices.length)];
            };

            const randIdx1 = getRandomUnusedIndex();
            const randIdx2 = getRandomUnusedIndex();

            if (randIdx1 === null || randIdx2 === null) {
                document.getElementById("tdp1").innerHTML = "모든 문제를 사용했습니다";
                document.getElementById("tdp2").innerHTML = "새로고침 해주세요";
                return;
            }

            used[randIdx1] = true;
            used[randIdx2] = true;

            document.getElementById("tdp1").innerHTML = problems[randIdx1][0];
            document.getElementById("tdp2").innerHTML = problems[randIdx2][0];
            
            // 정답 데이터 즉시 설정 (setTimeout 제거)
            document.getElementById("tda1").innerHTML = problems[randIdx1][1];
            document.getElementById("tda2").innerHTML = problems[randIdx2][1];
            document.getElementById("tdr1").innerHTML = problems[randIdx1][2];
            document.getElementById("tdr2").innerHTML = problems[randIdx2][2];
        }

        // 초기화 실행
        initApp();

        // 클릭 이벤트 핸들러 (confirm 제거)
        imageContainer.addEventListener('click', async () => {
            if (problemShow) {
                // 문제 → 정답 전환
                imageContainer.classList.add('flipped');
            } else {
                // 정답 → 새 문제 전환
                imageContainer.classList.remove('flipped');
                await funcProblemSetting();
            }
            problemShow = !problemShow;
        });
    </script>
</body>
</html>
