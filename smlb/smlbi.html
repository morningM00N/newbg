<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>슈퍼메가 럭키박스</title>
    <link rel="stylesheet" type="text/css" href="smlbi.css">
</head>

<body>
    <details open>
        <summary>Score</summary>
        <div id="indArea" class="indCard"></div>
    </details>
    <div id="newComponent" style="display:none;">
        <p style="width:100vw;text-align: center;">choose:</p>
    </div>
    <div id="playArea">
        <div style="width:100vw;align-items:center;justify-content:center;flex-wrap:wrap;display:flex;">
            <table style="width:100vw;">
                <tr style="width:100vw;">
                    <td style="width:30vw;text-align: center;">
                        <table style="width:100%">
                            <tr>
                                <td>M</td>
                                <td>-</td>
                                <td>0</td>
                                <td>+</td>
                            </tr>
                        </table>
                    </td>
                    <td rowspan="2">size: <input style="width:200px;" id="inputRange" type="range" step="0.001"
                            oninput="funcSizeChange(this)"></td>
                </tr>
                <tr>
                    <td style="width:30vw;text-align: center">
                        <table style="width:100%">
                            <tr>
                                <td>T</td>
                                <td>-</td>
                                <td>0</td>
                                <td>+</td>
                            </tr>
                        </table>

                    </td>
                </tr>

            </table>
        </div>
    </div>
    <script>

        function funcAddCard(numOfCards) {
            if (numOfCards == 5) { remainCards = 3 }
            else { remainCards = 1 }

            let newComponent = document.getElementById("newComponent")
            newComponent.style.display = "flex"
            let factor = 750 / (0.30 * document.documentElement.clientWidth)
            for (let index = 0; index < numOfCards; index++) {
                let cardIdx = Math.floor(Math.random() * cardInfor.length)
                while (cardIdx in storeData["usedCard"] == true) {
                    cardIdx = Math.floor(Math.random() * cardInfor.length)
                }
                storeData["usedCard"][cardIdx] = true
                let newCard = funcGetCard(cardIdx)
                newCard.style.setProperty("--factor", factor)
                newCard.id = "newCard" + index
                newComponent.appendChild(newCard)
                newCard.addEventListener('click', (event) => {
                    let elem = event.target
                    while (elem.id.includes("newCard") == false) {
                        elem = elem.parentElement
                    }
                    console.log(elem, cardIdx)
                    let ans = confirm(`${Number(elem.id.replace('newCard', '')) + 1}번째 카드를 고르겠습니까?`)
                    if (ans == true) {
                        --remainCards
                        newComponent.removeChild(elem)
                        document.getElementById('playArea').appendChild(funcGetCard(cardIdx))
                        storeData["selectedCard"].push(cardIdx)
                        if (remainCards == 0) {
                            while (newComponent.childElementCount > 1) {
                                newComponent.removeChild(newComponent.lastChild)
                            }
                            newComponent.style.display = "none"
                            localStorage.setItem("morningm00n_smlbi", JSON.stringify(storeData))
                        }
                    }
                    event.stopPropagation();
                }, true)
            }
        }
        function funcSizeChange(sliderElement) {
            document.documentElement.style.setProperty("--factor", 1 / sliderElement.value)
        }
        function funcX() {
            let classChecked = event.target.classList[0] + "Checked"
            event.target.classList.toggle(classChecked)
            if (event.target.classList.contains(classChecked)) {
                storeData["xmarked"][event.target.id] = true
            } else {
                delete storeData["xmarked"][event.target.id]
            }
            localStorage.setItem("morningm00n_smlbi", JSON.stringify(storeData))
        }
        function funcGetCard(id) {
            let cardIdx = Math.floor(Math.random() * cardInfor.length)
            let scoreCard = document.createElement('div')
            scoreCard.id = "scoreCard" + id
            scoreCard.style.setProperty("--sizeFactor", "750")
            scoreCard.className = "scoreCard"
            for (let index = 0; index < 9; index++) {
                let btn = document.createElement('button')
                btn.style.setProperty("--index", cardInfor[cardIdx][index])
                btn.style.setProperty("--indexmod", index % 3)
                btn.style.setProperty("--indexdivide", Math.floor(index / 3))
                btn.style.setProperty("--sizeFactor", "150")
                btn.className = "numberBtn"
                scoreCard.appendChild(btn)
                btn.id = `btn_${id}_${index}`
                btn.onclick = funcX
            }


            for (let index = 0; index < 3; index++) {
                let btn = document.createElement('button')
                scoreCard.appendChild(btn)
                btn.id = `btn_row_${id}_${index}`
                btn.className = "rowBonusContainer"
                btn.style.setProperty("--index", index)
                btn.style.setProperty("--sizeFactor", "179")

                let btn2 = document.createElement('button')
                btn.appendChild(btn2)
                btn2.id = `btn_row_bonus_${id}_${index}`
                btn2.className = "rowBonus"
                btn2.style.setProperty("--sizeFactor", 95)
                btn2.style.setProperty("--index", bonusAdValue[cardInfor[cardIdx][9 + index]])
                btn2.onclick = funcX
            }


            for (let index = 0; index < 3; index++) {
                let btn = document.createElement('button')
                scoreCard.appendChild(btn)
                btn.id = `btn_col_${id}_${index}`
                btn.style.setProperty("--sizeFactor", 179)
                btn.style.setProperty("--index", index)
                btn.className = "colBonusContainer"

                let btn2 = document.createElement('button')
                btn.appendChild(btn2)
                btn2.id = `btn_col_bonus_${id}_${index}`
                btn2.className = "colBonus"
                btn2.onclick = funcX
                btn2.style.setProperty("--sizeFactor", 95)
                btn2.style.setProperty("--index", bonusAdValue[cardInfor[cardIdx][12 + index]])

            }
            return scoreCard
        }
        function funcSetElementProperties(elem, properties) {
            for (const property in properties) {
                elem.style.setProperty(property, properties[property])
            }
        }


        let cardInfor = [
            "123456789q15sTm",
            "555555554qq2sTm"
        ]
        let bonusAdValue = {
            "q": 0, "1": 1, "2": 2, "3": 3, "4": 4, "5": 5, "6": 6, "7": 7,
            "8": 8, "9": 9, "s": 10, "t": 11, "T": 12, "m": 13, "e": 14
        }
        for (let i = 0; i < 60; i++) {
            let val = ""
            for (let index = 0; index < 9; index++) {
                val += (Math.floor(Math.random() * 9) + 1)
            }
            let keys = []
            for (let key in bonusAdValue) {
                keys.push(key)
            }
            for (let j = 0; j < 6; j++) {
                let idx = Math.floor(Math.random() * keys.length)
                val += keys[idx]
            }
            cardInfor.push(val)
        }
        let factor = 750 / (0.95 * document.documentElement.clientWidth)

        document.getElementById('inputRange').max = (0.95 * document.documentElement.clientWidth) / 750
        document.getElementById('inputRange').min = 50 / 750

        document.documentElement.style.setProperty("--factor", factor)
        document.getElementById("indArea").style.setProperty("--sizeFactor", 750)

        let indArea = document.getElementById('indArea')
        let roundOffset = 7.5
        let roundStep = 14.5
        for (let round = 0; round < 4; round++) {
            let btn = document.createElement('button')
            indArea.appendChild(btn)
            btn.className = "fixSizeElem"
            btn.id = "round_" + round
            btn.style.setProperty("--widthSize", 10)
            btn.style.setProperty("--heightSize", 10)
            btn.style.setProperty("--leftOffset", 8)
            btn.style.setProperty("--leftStep", 0)
            btn.style.setProperty("--leftIdx", 0)
            btn.style.setProperty("--topOffset", roundOffset)
            btn.style.setProperty("--topStep", roundStep)
            btn.style.setProperty("--topIdx", round)
            btn.onclick = function () {
                let res = confirm(`${round + 1} 라운드를 시작하겠습니까?`)
                if (res == true) {
                    if (round == 0) { funcAddCard(5) }
                    else { funcAddCard(3) }
                }
            }

            if (round < 3) {
                let inp = document.createElement('input')
                indArea.appendChild(inp)
                inp.className = "fixSizeElem"
                inp.id = "score_" + round
                let properties_round = {
                    "--fontSize": 0.5,
                    "--widthSize": 10,
                    "--heightSize": 10,
                    "--leftOffset": 80,
                    "--leftStep": 0,
                    "--leftIdx": 0,
                    "--topOffset": roundOffset,
                    "--topStep": roundStep,
                    "--topIdx": round,
                }
                funcSetElementProperties(inp, properties_round)
                inp.value = "20"
            }

            for (let index = 0; index < 3; index++) {
                let btn = document.createElement('button')
                indArea.appendChild(btn)
                btn.className = "fixSizeElem"
                btn.id = "complete_" + round + index
                btn.style.setProperty("--widthSize", 7)
                btn.style.setProperty("--heightSize", 10)
                btn.style.setProperty("--leftOffset", 20)
                btn.style.setProperty("--leftStep", 8)
                btn.style.setProperty("--leftIdx", index)
                btn.style.setProperty("--topOffset", roundOffset)
                btn.style.setProperty("--topStep", roundStep)
                btn.style.setProperty("--topIdx", round)
                btn.style.setProperty("--fontSize", 0.5)
                if (index == 0) {
                    btn.innerHTML = "-"
                    btn.onclick = function () {
                        let targetBtn = document.getElementById('complete_' + round + "1")
                        if (targetBtn.innerHTML == 1 || targetBtn.innerHTML == "") {
                            targetBtn.innerHTML = ""
                        } else {
                            targetBtn.innerHTML = Number(targetBtn.innerHTML) - 1
                        }
                    }
                }
                if (index == 2) {
                    btn.innerHTML = "+"
                    btn.onclick = function () {
                        let targetBtn = document.getElementById('complete_' + round + "1")
                        if (targetBtn.innerHTML == "") {
                            targetBtn.innerHTML = 1
                        } else {
                            targetBtn.innerHTML = Number(targetBtn.innerHTML) + 1
                        }
                    }
                }
            }

            for (let index = 0; index < 3; index++) {
                let btn = document.createElement('button')
                indArea.appendChild(btn)
                btn.className = "fixSizeElem"
                btn.id = "star_" + round + index
                let properties_star = {
                    "--widthSize": 7,
                    "--heightSize": 7,
                    "--leftOffset": 50,
                    "--leftStep": 8,
                    "--leftIdx": index,
                    "--topOffset": roundOffset,
                    "--topStep": roundStep,
                    "--topIdx": round
                }
                funcSetElementProperties(btn, properties_star)
                btn.onclick = function () {
                    event.target.classList.toggle("xMarked")
                    if (event.target.classList.contains("xMarked")) {
                        storeData["xmarkedclass"][event.target.id] = true
                    } else {
                        delete storeData["xmarkedclass"][event.target.id]
                    }
                    localStorage.setItem("morningm00n_smlbi", JSON.stringify(storeData))
                }
            }
        }

        let btn = document.createElement('button')
        indArea.appendChild(btn)
        btn.className = "fixSizeElem"
        btn.id = "total_score"
        let properties_total_score = {
            "--widthSize": 7,
            "--heightSize": 10,
            "--leftOffset": 80,
            "--leftStep": 0,
            "--leftIdx": 0,
            "--topOffset": 50,
            "--topStep": 0,
            "--topIdx": 0,
            "--fontSize": 0.5
        }
        funcSetElementProperties(btn, properties_total_score)
        btn.onclick = function () {
            let completeScore = [15, 12, 10, 8]
            let finalScore = 0
            for (let index = 0; index < 4; index++) {
                console.log(document.getElementById('complete_' + index + '1').innerHTML)
                finalScore += completeScore[index] * Number(`${document.getElementById('complete_' + index + '1').innerHTML}`)
            }

            let starScore = 0
            let starScoreArr = [1, 4, 9]
            for (let round = 0; round < 3; round++) {
                for (let index = 2; index >= 0; index--) {
                    if (document.getElementById("star_" + round + index).classList.contains("xMarked") == true) {
                        starScore += starScoreArr[index]
                        break
                    }
                }
            }

            document.getElementById('score_0').value = starScore;

            for (let index = 0; index < 3; index++) {
                finalScore += Number(`${document.getElementById('score_' + index).value}`)
            }


            // compute total score
            console.log(finalScore)
            event.target.innerHTML = finalScore
        }

        let storeData = null
        while (true) {
            storeData = localStorage.getItem("morningm00n_smlbi")
            if (storeData != null) {
                let ans = confirm("진행 중인 게임이 있습니다. 이어서 할까요?")
                if (ans == true) {
                    storeData = JSON.parse(storeData)
                    break
                } else {
                    let ans = confirm("새로운 게임을 시작할까요?")
                    if (ans == true) {
                        storeData = null
                        localStorage.removeItem('morningm00n_smlbi')
                    }
                }
            }
            if (storeData == null) {
                storeData = {}
                storeData["usedCard"] = {}
                storeData["xmarked"] = {}
                storeData["xmarkedclass"] = {}
                storeData["selectedCard"] = []
                break
            }
        }
        for (let cardIdx of storeData["selectedCard"]) {
            document.getElementById('playArea').appendChild(funcGetCard(cardIdx))
        }
        for (const id in storeData["xmarkedclass"]) {
            let elem = document.getElementById(id)
            let classChecked = elem.classList[0] + "Checked"
            elem.classList.toggle("xMarked")
        }
        for (const id in storeData["xmarked"]) {
            let elem = document.getElementById(id)
            let classChecked = elem.classList[0] + "Checked"
            elem.classList.toggle(classChecked)
        }

    </script>
</body>

</html>